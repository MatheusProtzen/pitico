"use strict";const h=require("node:http"),S=require("jsontypedef"),b=require("light-my-request"),w=require("raw-body"),z=require("ajv/dist/jtd.js"),f=Symbol("kRoutes"),u=Symbol("kDispatcher"),p=Symbol("kServer");function j(t){const a=new z,i=new Map,r={[f]:i,[u](e,n){const o=i.get(e.url),s=o?.handle;s?k(e,o).then(c=>s(c,n)).then(c=>v(n,o,c)).catch(c=>P(n,c)):C(n)},route(e,n){const{path:o,handle:s,parse:c,serialize:l}=typeof e=="function"?e(this,S):e,y=c&&a.compileParser(c),g=l&&a.compileSerializer(l),m=n??o;this[f].set(m,{parse:y,serialize:g,handle:s})},inject(e){return new Promise((n,o)=>{b(this[u],e,(s,c)=>{if(s)return o(s);n(c)})})},decorate(e,n){this[e]=n},decorateRequest(e,n){h.IncomingMessage.prototype[e]=n},async register(e,n){try{await e(this,n,o=>{o&&d(o)})}catch(o){d(o)}},async listen(e){return new Promise((n,o)=>{this[p].listen(e,s=>{if(s)return o(s);n()})})}};if(Array.isArray(t))for(const e of t)r.route(e.default??e,e.path);else for(const[e,n]of Object.entries(t))r.route(e,n);return r[p]=h.createServer(r[u]),r}h.IncomingMessage.prototype.body=null;function k(t,{parse:a}){return new Promise((i,r)=>{w(t,{length:t.headers["content-length"],limit:"1mb",encoding:"utf8"},(e,n)=>{if(e)return r(e);t.body=a(n),i(t)})})}function v(t,a,i){const r=a.serialize?a.serialize(i):JSON.stringify(i);t.writeHead(200,{"Content-Type":"application/json","Content-Length":Buffer.byteLength(r)}),t.end(r)}function C(t){t.statusCode=404,t.end("")}function P(t,a){const i=a.toString();t.statusCode=500,t.writeHead(200,{"Content-Type":"text/plain","Content-Length":Buffer.byteLength(i)}),t.end(i)}function d(t){console.error(t),process.exit(1)}module.exports=j;
