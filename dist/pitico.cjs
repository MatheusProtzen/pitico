"use strict";const h=require("node:http"),b=require("jsontypedef"),w=require("light-my-request"),k=require("raw-body"),R=require("ajv/dist/jtd.js"),f=Symbol("kRoutes"),u=Symbol("kDispatcher"),d=Symbol("kServer"),l=Symbol("kRoute");function z(t){const a=new R,i=new Map,r={[f]:i,[u](e,n){const o=i.get(e.url),s=o?.handle;s?C(e,o).then(c=>s(c,n)).then(c=>v(n,o,c)).catch(c=>j(n,c)):P(n)},[l](e,n){const{path:o,handle:s,parse:c,serialize:p}=typeof e=="function"?e(this,b):e,g=c&&a.compileParser(c),m=p&&a.compileSerializer(p),S=n??o;this[f].set(S,{parse:g,serialize:m,handle:s})},inject(e){return new Promise((n,o)=>{w(this[u],e,(s,c)=>{if(s)return o(s);n(c)})})},decorate(e,n){this[e]=n},decorateRequest(e,n){h.IncomingMessage.prototype[e]=n},async register(e,n){try{await e(this,n,o=>{o&&y(o)})}catch(o){y(o)}},async listen(e){return new Promise((n,o)=>{this[d].listen(e,s=>{if(s)return o(s);n()})})}};if(Array.isArray(t))for(const e of t)r[l](e.default??e,e.path);else for(const[e,n]of Object.entries(t))r[l](e,n);return r[d]=h.createServer(r[u]),r}h.IncomingMessage.prototype.body=null;function C(t,{parse:a}){return new Promise((i,r)=>{k(t,{length:t.headers["content-length"],limit:"1mb",encoding:"utf8"},(e,n)=>{if(e)return r(e);n&&(t.body=(a??JSON.parse)(n)),i(t)})})}function v(t,a,i){if(!i){t.setHeader("Content-Type","plain/text"),t.end("");return}const r=a.serialize?a.serialize(i):JSON.stringify(i);t.writeHead(200,{"Content-Type":"application/json","Content-Length":Buffer.byteLength(r)}),t.end(r)}function P(t){t.statusCode=404,t.end("")}function j(t,a){const i=a.toString();t.statusCode=500,t.writeHead(200,{"Content-Type":"text/plain","Content-Length":Buffer.byteLength(i)}),t.end(i)}function y(t){console.error(t),process.exit(1)}module.exports=z;
