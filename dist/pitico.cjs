"use strict";const p=require("node:http"),k=require("jsontypedef"),w=require("light-my-request"),R=require("raw-body"),z=require("ajv/dist/jtd.js"),d=Symbol("kRoutes"),l=Symbol("kDispatcher"),y=Symbol("kServer"),h=Symbol("kRoute");function C(t){const c=new z,i=new Map,u=()=>{},a={[d]:i,[l](e,n){const o=i.get(e.url),r=o?.handle;r?v(e,o).then(s=>r(s,n)).then(s=>P(n,o,s)).catch(s=>x(n,s)):j(n)},[h](e,n){const{path:o,handle:r,parse:s,serialize:f}=typeof e=="function"?e(this,k):e,m=s&&c.compileParser(s),S=f&&c.compileSerializer(f),b=n??o;this[d].set(b,{parse:m,serialize:S,handle:r})},addHook:u,inject(e){return new Promise((n,o)=>{w(this[l],e,(r,s)=>{if(r)return o(r);n(s)})})},decorate(e,n){this[e]=n},decorateRequest(e,n){p.IncomingMessage.prototype[e]=n},async register(e,n){try{await e(this,n,o=>{o&&g(o)})}catch(o){g(o)}},async listen(e){return new Promise((n,o)=>{this[y].listen(e,r=>{if(r)return o(r);n()})})}};if(Array.isArray(t))for(const e of t)a[h](e.default??e,e.path);else for(const[e,n]of Object.entries(t))a[h](e,n);return a[y]=p.createServer(a[l]),a}p.IncomingMessage.prototype.body=null;function v(t,{parse:c}){return new Promise((i,u)=>{R(t,{length:t.headers["content-length"],limit:"1mb",encoding:"utf8"},(a,e)=>{if(a)return u(a);e&&(t.body=(c??JSON.parse)(e)),i(t)})})}function P(t,c,i){if(!i){t.setHeader("Content-Type","plain/text"),t.end("");return}const u=c.serialize?c.serialize(i):JSON.stringify(i);t.writeHead(200,{"Content-Type":"application/json","Content-Length":Buffer.byteLength(u)}),t.end(u)}function j(t){t.statusCode=404,t.end("")}function x(t,c){const i=c.toString();t.statusCode=500,t.writeHead(200,{"Content-Type":"text/plain","Content-Length":Buffer.byteLength(i)}),t.end(i)}function g(t){console.error(t),process.exit(1)}module.exports=C;
