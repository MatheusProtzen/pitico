"use strict";const p=require("node:http"),k=require("jsontypedef"),R=require("light-my-request"),z=require("raw-body"),P=require("ajv/dist/jtd.js"),f=Symbol("kRoutes"),u=Symbol("kDispatcher"),y=Symbol("kServer"),l=Symbol("kRoute"),g=Symbol("kReady");function v(n){const a=new P,i=new Map,h=()=>{},c={[f]:i,[u](e,t){const o=i.get(e.url),s=o?.handle;s?C(e,o).then(r=>s(r,t)).then(r=>j(t,o,r)).catch(r=>H(t,r)):x(t)},async[l](e,t){const{path:o,handle:s,parse:r,serialize:d}=typeof e=="function"?await e(this,k):e,S=r&&a.compileParser(r),w=d&&a.compileSerializer(d),b=t??o;this[f].set(b,{parse:S,serialize:w,handle:s})},addHook:h,inject(e){return new Promise((t,o)=>{R(this[u],e,(s,r)=>{if(s)return o(s);t(r)})})},decorate(e,t){this[e]=t},decorateRequest(e,t){p.IncomingMessage.prototype[e]=t},async register(e,t){try{await e(this,t,o=>{o&&m(o)})}catch(o){m(o)}},async listen(e){return await this.ready(),new Promise((t,o)=>{this[y].listen(e,s=>{if(s)return o(s);t()})})},async ready(){if(this[g])return;const e=[];if(Array.isArray(n))for(const t of n)e.push(c[l](t.default??t,t.path));else for(const[t,o]of Object.entries(n))e.push(c[l](t,o));await Promise.all(e),this[g]=!0}};return c[y]=p.createServer(c[u]),c}p.IncomingMessage.prototype.body=null;function C(n,{parse:a}){return new Promise((i,h)=>{z(n,{length:n.headers["content-length"],limit:"1mb",encoding:"utf8"},(c,e)=>{if(c)return h(c);e&&(n.body=(a??JSON.parse)(e)),i(n)})})}function j(n,a,i){if(!i){n.setHeader("Content-Type","plain/text"),n.end("");return}const h=a.serialize?a.serialize(i):JSON.stringify(i);n.writeHead(200,{"Content-Type":"application/json","Content-Length":Buffer.byteLength(h)}),n.end(h)}function x(n){n.statusCode=404,n.end("")}function H(n,a){const i=a.toString();n.writeHead(500,{"Content-Type":"text/plain","Content-Length":Buffer.byteLength(i)}),n.end(i)}function m(n){console.error(n),process.exit(1)}module.exports=v;
