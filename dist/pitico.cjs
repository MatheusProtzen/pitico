"use strict";const M=require("node:http"),te=require("jsontypedef"),ne=require("light-my-request"),ie=require("raw-body"),se=require("ajv/dist/jtd.js");var oe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ae(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var F={exports:{}};/*!
 * forwarded
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */var ue=le;function le(e){if(!e)throw new TypeError("argument req is required");var i=ce(e.headers["x-forwarded-for"]||""),n=fe(e),a=[n].concat(i);return a}function fe(e){return e.socket?e.socket.remoteAddress:e.connection.remoteAddress}function ce(e){for(var i=e.length,n=[],a=e.length,c=e.length-1;c>=0;c--)switch(e.charCodeAt(c)){case 32:a===i&&(a=i=c);break;case 44:a!==i&&n.push(e.substring(a,i)),a=i=c;break;default:a=c;break}return a!==i&&n.push(e.substring(a,i)),n}var V={exports:{}};V.exports;(function(e){(function(){var i,n,a,c,p,m,w,h,u;n={},h=this,e!==null&&e.exports?e.exports=n:h.ipaddr=n,w=function(r,t,o,s){var f,l;if(r.length!==t.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");for(f=0;s>0;){if(l=o-s,l<0&&(l=0),r[f]>>l!==t[f]>>l)return!1;s-=o,f+=1}return!0},n.subnetMatch=function(r,t,o){var s,f,l,d,v;o==null&&(o="unicast");for(l in t)for(d=t[l],d[0]&&!(d[0]instanceof Array)&&(d=[d]),s=0,f=d.length;s<f;s++)if(v=d[s],r.kind()===v[0].kind()&&r.match.apply(r,v))return l;return o},n.IPv4=function(){function r(t){var o,s,f;if(t.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");for(o=0,s=t.length;o<s;o++)if(f=t[o],!(0<=f&&f<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=t}return r.prototype.kind=function(){return"ipv4"},r.prototype.toString=function(){return this.octets.join(".")},r.prototype.toNormalizedString=function(){return this.toString()},r.prototype.toByteArray=function(){return this.octets.slice(0)},r.prototype.match=function(t,o){var s;if(o===void 0&&(s=t,t=s[0],o=s[1]),t.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return w(this.octets,t.octets,8,o)},r.prototype.SpecialRanges={unspecified:[[new r([0,0,0,0]),8]],broadcast:[[new r([255,255,255,255]),32]],multicast:[[new r([224,0,0,0]),4]],linkLocal:[[new r([169,254,0,0]),16]],loopback:[[new r([127,0,0,0]),8]],carrierGradeNat:[[new r([100,64,0,0]),10]],private:[[new r([10,0,0,0]),8],[new r([172,16,0,0]),12],[new r([192,168,0,0]),16]],reserved:[[new r([192,0,0,0]),24],[new r([192,0,2,0]),24],[new r([192,88,99,0]),24],[new r([198,51,100,0]),24],[new r([203,0,113,0]),24],[new r([240,0,0,0]),4]]},r.prototype.range=function(){return n.subnetMatch(this,this.SpecialRanges)},r.prototype.toIPv4MappedAddress=function(){return n.IPv6.parse("::ffff:"+this.toString())},r.prototype.prefixLengthFromSubnetMask=function(){var t,o,s,f,l,d,v;for(v={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0},t=0,l=!1,o=s=3;s>=0;o=s+=-1)if(f=this.octets[o],f in v){if(d=v[f],l&&d!==0)return null;d!==8&&(l=!0),t+=d}else return null;return 32-t},r}(),a="(0?\\d+|0x[a-f0-9]+)",c={fourOctet:new RegExp("^"+a+"\\."+a+"\\."+a+"\\."+a+"$","i"),longValue:new RegExp("^"+a+"$","i")},n.IPv4.parser=function(r){var t,o,s,f,l;if(o=function(d){return d[0]==="0"&&d[1]!=="x"?parseInt(d,8):parseInt(d)},t=r.match(c.fourOctet))return function(){var d,v,y,b;for(y=t.slice(1,6),b=[],d=0,v=y.length;d<v;d++)s=y[d],b.push(o(s));return b}();if(t=r.match(c.longValue)){if(l=o(t[1]),l>4294967295||l<0)throw new Error("ipaddr: address outside defined range");return function(){var d,v;for(v=[],f=d=0;d<=24;f=d+=8)v.push(l>>f&255);return v}().reverse()}else return null},n.IPv6=function(){function r(t,o){var s,f,l,d,v,y;if(t.length===16)for(this.parts=[],s=f=0;f<=14;s=f+=2)this.parts.push(t[s]<<8|t[s+1]);else if(t.length===8)this.parts=t;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(y=this.parts,l=0,d=y.length;l<d;l++)if(v=y[l],!(0<=v&&v<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");o&&(this.zoneId=o)}return r.prototype.kind=function(){return"ipv6"},r.prototype.toString=function(){return this.toNormalizedString().replace(/((^|:)(0(:|$))+)/,"::")},r.prototype.toRFC5952String=function(){var t,o,s,f,l;for(f=/((^|:)(0(:|$)){2,})/g,l=this.toNormalizedString(),t=0,o=-1;s=f.exec(l);)s[0].length>o&&(t=s.index,o=s[0].length);return o<0?l:l.substring(0,t)+"::"+l.substring(t+o)},r.prototype.toByteArray=function(){var t,o,s,f,l;for(t=[],l=this.parts,o=0,s=l.length;o<s;o++)f=l[o],t.push(f>>8),t.push(f&255);return t},r.prototype.toNormalizedString=function(){var t,o,s;return t=function(){var f,l,d,v;for(d=this.parts,v=[],f=0,l=d.length;f<l;f++)o=d[f],v.push(o.toString(16));return v}.call(this).join(":"),s="",this.zoneId&&(s="%"+this.zoneId),t+s},r.prototype.toFixedLengthString=function(){var t,o,s;return t=function(){var f,l,d,v;for(d=this.parts,v=[],f=0,l=d.length;f<l;f++)o=d[f],v.push(o.toString(16).padStart(4,"0"));return v}.call(this).join(":"),s="",this.zoneId&&(s="%"+this.zoneId),t+s},r.prototype.match=function(t,o){var s;if(o===void 0&&(s=t,t=s[0],o=s[1]),t.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return w(this.parts,t.parts,16,o)},r.prototype.SpecialRanges={unspecified:[new r([0,0,0,0,0,0,0,0]),128],linkLocal:[new r([65152,0,0,0,0,0,0,0]),10],multicast:[new r([65280,0,0,0,0,0,0,0]),8],loopback:[new r([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new r([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new r([0,0,0,0,0,65535,0,0]),96],rfc6145:[new r([0,0,0,0,65535,0,0,0]),96],rfc6052:[new r([100,65435,0,0,0,0,0,0]),96],"6to4":[new r([8194,0,0,0,0,0,0,0]),16],teredo:[new r([8193,0,0,0,0,0,0,0]),32],reserved:[[new r([8193,3512,0,0,0,0,0,0]),32]]},r.prototype.range=function(){return n.subnetMatch(this,this.SpecialRanges)},r.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},r.prototype.toIPv4Address=function(){var t,o,s;if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");return s=this.parts.slice(-2),t=s[0],o=s[1],new n.IPv4([t>>8,t&255,o>>8,o&255])},r.prototype.prefixLengthFromSubnetMask=function(){var t,o,s,f,l,d,v;for(v={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0},t=0,l=!1,o=s=7;s>=0;o=s+=-1)if(f=this.parts[o],f in v){if(d=v[f],l&&d!==0)return null;d!==16&&(l=!0),t+=d}else return null;return 128-t},r}(),p="(?:[0-9a-f]+::?)+",u="%[0-9a-z]{1,}",m={zoneIndex:new RegExp(u,"i"),native:new RegExp("^(::)?("+p+")?([0-9a-f]+)?(::)?("+u+")?$","i"),transitional:new RegExp("^((?:"+p+")|(?:::)(?:"+p+")?)"+(a+"\\."+a+"\\."+a+"\\."+a)+("("+u+")?$"),"i")},i=function(r,t){var o,s,f,l,d,v;if(r.indexOf("::")!==r.lastIndexOf("::"))return null;for(v=(r.match(m.zoneIndex)||[])[0],v&&(v=v.substring(1),r=r.replace(/%.+$/,"")),o=0,s=-1;(s=r.indexOf(":",s+1))>=0;)o++;if(r.substr(0,2)==="::"&&o--,r.substr(-2,2)==="::"&&o--,o>t)return null;for(d=t-o,l=":";d--;)l+="0:";return r=r.replace("::",l),r[0]===":"&&(r=r.slice(1)),r[r.length-1]===":"&&(r=r.slice(0,-1)),t=function(){var y,b,P,I;for(P=r.split(":"),I=[],y=0,b=P.length;y<b;y++)f=P[y],I.push(parseInt(f,16));return I}(),{parts:t,zoneId:v}},n.IPv6.parser=function(r){var t,o,s,f,l,d,v;if(m.native.test(r))return i(r,8);if((f=r.match(m.transitional))&&(v=f[6]||"",t=i(f[1].slice(0,-1)+v,6),t.parts)){for(d=[parseInt(f[2]),parseInt(f[3]),parseInt(f[4]),parseInt(f[5])],o=0,s=d.length;o<s;o++)if(l=d[o],!(0<=l&&l<=255))return null;return t.parts.push(d[0]<<8|d[1]),t.parts.push(d[2]<<8|d[3]),{parts:t.parts,zoneId:t.zoneId}}return null},n.IPv4.isIPv4=n.IPv6.isIPv6=function(r){return this.parser(r)!==null},n.IPv4.isValid=function(r){try{return new this(this.parser(r)),!0}catch{return!1}},n.IPv4.isValidFourPartDecimal=function(r){return!!(n.IPv4.isValid(r)&&r.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},n.IPv6.isValid=function(r){var t;if(typeof r=="string"&&r.indexOf(":")===-1)return!1;try{return t=this.parser(r),new this(t.parts,t.zoneId),!0}catch{return!1}},n.IPv4.parse=function(r){var t;if(t=this.parser(r),t===null)throw new Error("ipaddr: string is not formatted like ip address");return new this(t)},n.IPv6.parse=function(r){var t;if(t=this.parser(r),t.parts===null)throw new Error("ipaddr: string is not formatted like ip address");return new this(t.parts,t.zoneId)},n.IPv4.parseCIDR=function(r){var t,o,s;if((o=r.match(/^(.+)\/(\d+)$/))&&(t=parseInt(o[2]),t>=0&&t<=32))return s=[this.parse(o[1]),t],Object.defineProperty(s,"toString",{value:function(){return this.join("/")}}),s;throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},n.IPv4.subnetMaskFromPrefixLength=function(r){var t,o,s;if(r=parseInt(r),r<0||r>32)throw new Error("ipaddr: invalid IPv4 prefix length");for(s=[0,0,0,0],o=0,t=Math.floor(r/8);o<t;)s[o]=255,o++;return t<4&&(s[t]=Math.pow(2,r%8)-1<<8-r%8),new this(s)},n.IPv4.broadcastAddressFromCIDR=function(r){var t,o,s,f,l;try{for(t=this.parseCIDR(r),s=t[0].toByteArray(),l=this.subnetMaskFromPrefixLength(t[1]).toByteArray(),f=[],o=0;o<4;)f.push(parseInt(s[o],10)|parseInt(l[o],10)^255),o++;return new this(f)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},n.IPv4.networkAddressFromCIDR=function(r){var t,o,s,f,l;try{for(t=this.parseCIDR(r),s=t[0].toByteArray(),l=this.subnetMaskFromPrefixLength(t[1]).toByteArray(),f=[],o=0;o<4;)f.push(parseInt(s[o],10)&parseInt(l[o],10)),o++;return new this(f)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},n.IPv6.parseCIDR=function(r){var t,o,s;if((o=r.match(/^(.+)\/(\d+)$/))&&(t=parseInt(o[2]),t>=0&&t<=128))return s=[this.parse(o[1]),t],Object.defineProperty(s,"toString",{value:function(){return this.join("/")}}),s;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},n.isValid=function(r){return n.IPv6.isValid(r)||n.IPv4.isValid(r)},n.parse=function(r){if(n.IPv6.isValid(r))return n.IPv6.parse(r);if(n.IPv4.isValid(r))return n.IPv4.parse(r);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},n.parseCIDR=function(r){try{return n.IPv6.parseCIDR(r)}catch{try{return n.IPv4.parseCIDR(r)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},n.fromByteArray=function(r){var t;if(t=r.length,t===4)return new n.IPv4(r);if(t===16)return new n.IPv6(r);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},n.process=function(r){var t;return t=this.parse(r),t.kind()==="ipv6"&&t.isIPv4MappedAddress()?t.toIPv4Address():t}}).call(oe)})(V);var de=V.exports;/*!
 * proxy-addr
 * Copyright(c) 2014-2016 Douglas Christopher Wilson
 * MIT Licensed
 */F.exports=be;F.exports.all=Q;F.exports.compile=Y;var pe=ue,K=de,he=/^[0-9]+$/,S=K.isValid,A=K.parse,B={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};function Q(e,i){var n=pe(e);if(!i)return n;typeof i!="function"&&(i=Y(i));for(var a=0;a<n.length-1;a++)i(n[a],a)||(n.length=a+1);return n}function Y(e){if(!e)throw new TypeError("argument is required");var i;if(typeof e=="string")i=[e];else if(Array.isArray(e))i=e.slice();else throw new TypeError("unsupported trust argument");for(var n=0;n<i.length;n++)e=i[n],Object.prototype.hasOwnProperty.call(B,e)&&(e=B[e],i.splice.apply(i,[n,1].concat(e)),n+=e.length-1);return we(ve(i))}function ve(e){for(var i=new Array(e.length),n=0;n<e.length;n++)i[n]=me(e[n]);return i}function we(e){var i=e.length;return i===0?ge:i===1?ke(e[0]):Ie(e)}function me(e){var i=e.lastIndexOf("/"),n=i!==-1?e.substring(0,i):e;if(!S(n))throw new TypeError("invalid IP address: "+n);var a=A(n);i===-1&&a.kind()==="ipv6"&&a.isIPv4MappedAddress()&&(a=a.toIPv4Address());var c=a.kind()==="ipv6"?128:32,p=i!==-1?e.substring(i+1,e.length):null;if(p===null?p=c:he.test(p)?p=parseInt(p,10):a.kind()==="ipv4"&&S(p)?p=ye(p):p=null,p<=0||p>c)throw new TypeError("invalid range on address: "+e);return[a,p]}function ye(e){var i=A(e),n=i.kind();return n==="ipv4"?i.prefixLengthFromSubnetMask():null}function be(e,i){if(!e)throw new TypeError("req argument is required");if(!i)throw new TypeError("trust argument is required");var n=Q(e,i),a=n[n.length-1];return a}function ge(){return!1}function Ie(e){return function(n){if(!S(n))return!1;for(var a=A(n),c,p=a.kind(),m=0;m<e.length;m++){var w=e[m],h=w[0],u=h.kind(),r=w[1],t=a;if(p!==u){if(u==="ipv4"&&!a.isIPv4MappedAddress())continue;c||(c=u==="ipv4"?a.toIPv4Address():a.toIPv4MappedAddress()),t=c}if(t.match(h,r))return!0}return!1}}function ke(e){var i=e[0],n=i.kind(),a=n==="ipv4",c=e[1];return function(m){if(!S(m))return!1;var w=A(m),h=w.kind();if(h!==n){if(a&&!w.isIPv4MappedAddress())return!1;w=a?w.toIPv4Address():w.toIPv4MappedAddress()}return w.match(i,c)}}var j={exports:{}};function Pe(e){try{return JSON.stringify(e)}catch{return'"[Circular]"'}}var xe=ze;function ze(e,i,n){var a=n&&n.stringify||Pe,c=1;if(typeof e=="object"&&e!==null){var p=i.length+c;if(p===1)return e;var m=new Array(p);m[0]=a(e);for(var w=1;w<p;w++)m[w]=a(i[w]);return m.join(" ")}if(typeof e!="string")return e;var h=i.length;if(h===0)return e;for(var u="",r=1-c,t=-1,o=e&&e.length||0,s=0;s<o;){if(e.charCodeAt(s)===37&&s+1<o){switch(t=t>-1?t:0,e.charCodeAt(s+1)){case 100:case 102:if(r>=h||i[r]==null)break;t<s&&(u+=e.slice(t,s)),u+=Number(i[r]),t=s+2,s++;break;case 105:if(r>=h||i[r]==null)break;t<s&&(u+=e.slice(t,s)),u+=Math.floor(Number(i[r])),t=s+2,s++;break;case 79:case 111:case 106:if(r>=h||i[r]===void 0)break;t<s&&(u+=e.slice(t,s));var f=typeof i[r];if(f==="string"){u+="'"+i[r]+"'",t=s+2,s++;break}if(f==="function"){u+=i[r].name||"<anonymous>",t=s+2,s++;break}u+=a(i[r]),t=s+2,s++;break;case 115:if(r>=h)break;t<s&&(u+=e.slice(t,s)),u+=String(i[r]),t=s+2,s++;break;case 37:t<s&&(u+=e.slice(t,s)),u+="%",t=s+2,s++,r--;break}++r}++s}return t===-1?e:(t<o&&(u+=e.slice(t)),u)}const G=xe;j.exports=g;const x=Ne().console||{},Ee={mapHttpRequest:E,mapHttpResponse:E,wrapRequestSerializer:C,wrapResponseSerializer:C,wrapErrorSerializer:C,req:E,res:E,err:J,errWithCause:J};function O(e,i){return e==="silent"?1/0:i.levels.values[e]}const N=Symbol("pino.logFuncs"),T=Symbol("pino.hierarchy"),Se={error:"log",fatal:"error",warn:"error",info:"log",debug:"log",trace:"log"};function H(e,i){const n={logger:i,parent:e[T]};i[T]=n}function Oe(e,i,n){const a={};i.forEach(c=>{a[c]=n[c]?n[c]:x[c]||x[Se[c]||"log"]||z}),e[N]=a}function Ae(e,i){return Array.isArray(e)?e.filter(function(a){return a!=="!stdSerializers.err"}):e===!0?Object.keys(i):!1}function g(e){e=e||{},e.browser=e.browser||{};const i=e.browser.transmit;if(i&&typeof i.send!="function")throw Error("pino: transmit option must have a send function");const n=e.browser.write||x;e.browser.write&&(e.browser.asObject=!0);const a=e.serializers||{},c=Ae(e.browser.serialize,a);let p=e.browser.serialize;Array.isArray(e.browser.serialize)&&e.browser.serialize.indexOf("!stdSerializers.err")>-1&&(p=!1);const m=Object.keys(e.customLevels||{}),w=["error","fatal","warn","info","debug","trace"].concat(m);typeof n=="function"&&w.forEach(function(l){n[l]=n}),(e.enabled===!1||e.browser.disabled)&&(e.level="silent");const h=e.level||"info",u=Object.create(n);u.log||(u.log=z),Oe(u,w,n),H({},u),Object.defineProperty(u,"levelVal",{get:t}),Object.defineProperty(u,"level",{get:o,set:s});const r={transmit:i,serialize:c,asObject:e.browser.asObject,levels:w,timestamp:De(e)};u.levels=je(e),u.level=h,u.setMaxListeners=u.getMaxListeners=u.emit=u.addListener=u.on=u.prependListener=u.once=u.prependOnceListener=u.removeListener=u.removeAllListeners=u.listeners=u.listenerCount=u.eventNames=u.write=u.flush=z,u.serializers=a,u._serialize=c,u._stdErrSerialize=p,u.child=f,i&&(u._logEvent=D());function t(){return O(this.level,this)}function o(){return this._level}function s(l){if(l!=="silent"&&!this.levels.values[l])throw Error("unknown level "+l);this._level=l,k(this,r,u,"error"),k(this,r,u,"fatal"),k(this,r,u,"warn"),k(this,r,u,"info"),k(this,r,u,"debug"),k(this,r,u,"trace"),m.forEach(d=>{k(this,r,u,d)})}function f(l,d){if(!l)throw new Error("missing bindings for child Pino");d=d||{},c&&l.serializers&&(d.serializers=l.serializers);const v=d.serializers;if(c&&v){var y=Object.assign({},a,v),b=e.browser.serialize===!0?Object.keys(y):c;delete l.serializers,R([l],b,y,this._stdErrSerialize)}function P($){this._childLevel=($._childLevel|0)+1,this.bindings=l,y&&(this.serializers=y,this._serialize=b),i&&(this._logEvent=D([].concat($._logEvent.bindings,l)))}P.prototype=this;const I=new P(this);return H(this,I),I.level=this.level,I}return u}function je(e){const i=e.customLevels||{},n=Object.assign({},g.levels.values,i),a=Object.assign({},g.levels.labels,Re(i));return{values:n,labels:a}}function Re(e){const i={};return Object.keys(e).forEach(function(n){i[e[n]]=n}),i}g.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}};g.stdSerializers=Ee;g.stdTimeFunctions=Object.assign({},{nullTime:Z,epochTime:ee,unixTime:Fe,isoTime:Ve});function Ce(e){const i=[];e.bindings&&i.push(e.bindings);let n=e[T];for(;n.parent;)n=n.parent,n.logger.bindings&&i.push(n.logger.bindings);return i.reverse()}function k(e,i,n,a){if(e[a]=O(e.level,n)>O(a,n)?z:n[N][a],!i.transmit&&e[a]===z)return;e[a]=_e(e,i,n,a);const c=Ce(e);c.length!==0&&(e[a]=Le(c,e[a]))}function Le(e,i){return function(){return i.apply(this,[...e,...arguments])}}function _e(e,i,n,a){return function(c){return function(){const m=i.timestamp(),w=new Array(arguments.length),h=Object.getPrototypeOf&&Object.getPrototypeOf(this)===x?x:this;for(var u=0;u<w.length;u++)w[u]=arguments[u];if(i.serialize&&!i.asObject&&R(w,this._serialize,this.serializers,this._stdErrSerialize),i.asObject?c.call(h,Me(this,a,w,m)):c.apply(h,w),i.transmit){const r=i.transmit.level||e._level,t=n.levels.values[r],o=n.levels.values[a];if(o<t)return;Te(this,{ts:m,methodLevel:a,methodValue:o,transmitLevel:r,transmitValue:n.levels.values[i.transmit.level||e._level],send:i.transmit.send,val:O(e._level,n)},w)}}}(e[N][a])}function Me(e,i,n,a){e._serialize&&R(n,e._serialize,e.serializers,e._stdErrSerialize);const c=n.slice();let p=c[0];const m={};a&&(m.time=a),m.level=e.levels.values[i];let w=(e._childLevel|0)+1;if(w<1&&(w=1),p!==null&&typeof p=="object"){for(;w--&&typeof c[0]=="object";)Object.assign(m,c.shift());p=c.length?G(c.shift(),c):void 0}else typeof p=="string"&&(p=G(c.shift(),c));return p!==void 0&&(m.msg=p),m}function R(e,i,n,a){for(const c in e)if(a&&e[c]instanceof Error)e[c]=g.stdSerializers.err(e[c]);else if(typeof e[c]=="object"&&!Array.isArray(e[c]))for(const p in e[c])i&&i.indexOf(p)>-1&&p in n&&(e[c][p]=n[p](e[c][p]))}function Te(e,i,n){const a=i.send,c=i.ts,p=i.methodLevel,m=i.methodValue,w=i.val,h=e._logEvent.bindings;R(n,e._serialize||Object.keys(e.serializers),e.serializers,e._stdErrSerialize===void 0?!0:e._stdErrSerialize),e._logEvent.ts=c,e._logEvent.messages=n.filter(function(u){return h.indexOf(u)===-1}),e._logEvent.level.label=p,e._logEvent.level.value=m,a(p,e._logEvent,w),e._logEvent=D(h)}function D(e){return{ts:0,messages:[],bindings:e||[],level:{label:"",value:0}}}function J(e){const i={type:e.constructor.name,msg:e.message,stack:e.stack};for(const n in e)i[n]===void 0&&(i[n]=e[n]);return i}function De(e){return typeof e.timestamp=="function"?e.timestamp:e.timestamp===!1?Z:ee}function E(){return{}}function C(e){return e}function z(){}function Z(){return!1}function ee(){return Date.now()}function Fe(){return Math.round(Date.now()/1e3)}function Ve(){return new Date(Date.now()).toISOString()}function Ne(){function e(i){return typeof i<"u"&&i}try{return typeof globalThis<"u"||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch{return e(self)||e(window)||e(this)||{}}}j.exports.default=g;j.exports.pino=g;var $e=j.exports;const re=ae($e),Be={req(e){return{method:e.method,url:e.url,version:e.headers&&e.headers["accept-version"],hostname:e.host,remoteAddress:e.socket.remoteAddress,remotePort:e.socket?e.socket.remotePort:void 0}},err:re.stdSerializers.err,res(e){return{statusCode:e.statusCode}}},q=Symbol("kRoutes"),L=Symbol("kDispatcher"),W=Symbol("kServer"),_=Symbol("kRoute"),U=Symbol("kReady");function Ge(e,i={}){const n=new se,a=new Map,c=()=>{};let p=i.logger;!p&&p!==!1&&(p=re({serializers:Be}));const m={log:p},w={[q]:a,[L](h,u){const r=a.get(h.url),t=r?.handle;t?He.call(m,h,u,r).then(o=>t(o,u)).then(o=>Je(u,r,o)).catch(o=>We(h,u,o,p)):qe(u)},async[_](h,u){const{path:r,handle:t,parse:o,serialize:s}=typeof h=="function"?await h(this,te):h,f=o&&n.compileParser(o),l=s&&n.compileSerializer(s),d=u??r;this[q].set(d,{parse:f,serialize:l,handle:t})},addHook:c,inject(h){return new Promise((u,r)=>{ne(this[L],h,(t,o)=>{if(t)return r(t);u(o)})})},decorate(h,u){this[h]=u},decorateRequest(h,u){M.IncomingMessage.prototype[h]=u},async register(h,u){try{await h(this,u,r=>{r&&X(r)})}catch(r){X(r)}},async listen(h){return await this.ready(),new Promise((u,r)=>{this[W].listen(h,t=>{if(t)return r(t);u()})})},async ready(){if(this[U])return;const h=[];if(Array.isArray(e))for(const u of e)h.push(w[_](u.default??u,u.path));else for(const[u,r]of Object.entries(e))h.push(w[_](u,r));await Promise.all(h),this[U]=!0}};return w[W]=M.createServer(w[L]),w}M.IncomingMessage.prototype.body=null;function He(e,i,{parse:n}){return new Promise((a,c)=>{ie(e,{length:e.headers["content-length"],limit:"1mb",encoding:"utf8"},(p,m)=>{if(p)return c(p);m&&(e.body=(n??JSON.parse)(m)),this.log.info({req:e,res:i}),a(e)})})}function Je(e,i,n){if(!n){e.setHeader("Content-Type","plain/text"),e.end("");return}const a=i.serialize?i.serialize(n):JSON.stringify(n);e.writeHead(200,{"Content-Type":"application/json","Content-Length":Buffer.byteLength(a)}),e.end(a)}function qe(e){e.statusCode=404,e.end("")}function We(e,i,n,a){i.writeHead(500,{"Content-Type":"text/plain","Content-Length":0}),i.end(""),a.error({err:n,req:e,res:i})}function X(e){console.error(e),process.exit(1)}module.exports=Ge;
